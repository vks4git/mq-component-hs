# mq-component-hs

## Сборка

Сборка данной библиотеки осуществляется из внутренней сети компании BIOCAD (до того момента, как данный компонент будет переведён в hackage) с помощью инструмента [stack](https://www.haskellstack.org/):

```
stack build
```

## Использование в сторонних библиотеках

Данная библиотека используется при разработке компонентов на языке haskell.
Её необходимо подключить в зависимостях разрабатываемой библиотеки. 

## Создание нового компонента

Порядок создания нового компонента описан [тут](doc/Develop.md).

## Запуск примеров

Подразумевается, что "одно место" у вас уже запущено на локальной машине (подробнее читай в документации [mq](https://github.com/biocad/mq)).

Перед запуском необходимо собрать все примеры с помощью команды

```
stack build
```

### Пример "радио"

Является примером асинхронного общения двух компонентов: один умеет формировать и рассылать сообщения, а другой их получать и обрабатывать.

Типы сообщений для данного примера определены в [этом](app/ExampleRadioTypes.hs) файле. 

"Радио точка" реализована в [этом](app/ExampleRadioSpeaker.hs) файле и запускается с помощью команды

```
stack exec example-radio-speaker
```

Получатель сообщений реализован в [этом](app/ExampleRadioListener.hs) файле и запускается с помощью команды

```
stack exec example-radio-listener
```

Можно обратить внимание на то, что получатель сообщений реализован с использованием [соответствующего](src/System/MQ/Component/Extras/Template/Listener.hs) шаблона.

### Пример "калькулятор"

Является примером компонента, который умеет принять соответствующее сообщение с конфигурацией, обработать его и отправить результат обратно.
Раньше такой компонент назывался "рабочим".

Типы сообщений для данного примера определены в [этом](app/ExampleCalculatorTypes.hs) файле.

Логика простейшего калькулятора описана в [этом](app/ExampleCalculator.hs) файле, а запускается он с помощью команды

```
stack exec example-calculator
```

Поставить задачу этому компоненту можно с помощью библиотеки [mq-jobcontrol](https://github.com/biocad/mq-jobcontrol).
Необходимо помнить, что калькулятор к этому моменту уже должен быть запущен.

Можно обратить внимание на то, что калькулятор реализован с использованием [соответствующего](src/System/MQ/Component/Extras/Template/Worker.hs) шаблона.

### Пример "банк"

Является примером того, как один компонент при выполнении задачи может использовать другой компонент.
При выполнении задачи банк будет использовать компонент из примера "калькулятор", который описан выше.
Поэтому и его тоже надо запустить.

Типы сообщений для данного примера определены в [этом](app/ExampleBankTypes.hs) файле.

Логика нашего банка определена в [этом](app/ExampleBank.hs) файле, а запускается он с помощью команды

```
stack exec example-bank
```

Поставить задачу этому компоненту можно также с помощью библиотеки [mq-jobcontrol](https://github.com/biocad/mq-jobcontrol).

Можно обратить внимание на то, что банк использует [шаблон](src/System/MQ/Component/Extras/Template/Worker.hs) "рабочего" и [вызов удалённого компонента](src/System/MQ/Component/Extras/Foreign.hs).

### Пример "часики"

Является примером компонента, задачи на который распределяются через контроллер (для более подробной информации читай [тут](https://github.com/biocad/mq/blob/master/doc/Controller.md)).

Типы сообщений для данного примера определены в [этом](app/ExampleClockTypes.hs) файле.

Пример состоит из двух частей.
Первая часть принимает сообщение от соответствующего контроллера и возвращает в очередь ответ с текущим временем.
Логика этого компонента определена в этом файле


Компонент, который выполняет работу, описан в [этом](app/ExampleClockReply.hs) файле.
Перед запускам этого компонента необходимо запустить контроллер.
Как именно это сделать, описано в [этом](https://github.com/biocad/mq-controller) репозитории.
Для запуска _конкретно этого_ примера никаких правок в файле `config.json` производить не следует.

После запуска контроллера сам компонент можно запустить с помощью команды 

```
stack exec example-clock-reply
stack exec example-clock-reply
```

Здесь приведена одна и та же команда.
Их можно ввести в различных терминалах.
Если всё будет запущено правильно, то после запуска второй части (которая описана ниже) можно будет увидеть, что эти два приложения будут по очереди принимать и выполнять задачи.

Вторая часть совсем простая.
Это самый обычный компонент, который в некоторой периодичностью отправляет в очередь вопрос, а получив на него ответ просто его печатает.
Логика этого компонента описана в [этом](app/ExampleClockAsk.hs) файле и его можно запустить с помощью команды

```
stack exec example-clock-ask
```

## Порядок реализации компонента

Как вы уже наверняка знаете, для полноценной работы компонента в его обёртке необходимо реализовать различную функциональность.
Ниже приведены указания на места в библиотеке с соответствующей реализацией.

Основные модули:
  * [Протокол](https://github.com/biocad/mq/tree/master/src/System/MQ/Protocol)
  * [Транспортный слой](src/System/MQ/Component/Internal/Transport.hs)
  * [Межпоточное общение между техническим и коммуникационным слоями](src/System/MQ/Component/Internal/Atomic)
  * [Технический слой](src/System/MQ/Component/Internal/Technical)
    * [Логика мониторинга](src/System/MQ/Component/Internal/Technical/Monitoring.hs)
    * [Логика "убийства" задач](src/System/MQ/Component/Internal/Technical/Kill.hs)
  * Коммуникационный слой (реализуется в каждом компоненте отдельно)
  * [Конфигурации](src/System/MQ/Component/Internal/Config.hs)
  * [Окружения](src/System/MQ/Component/Internal/Env.hs)
  * [Запуск приложения](src/System/MQ/Component/Internal/App.hs)
  
Дополнительные модули:
  * [Формирование ошибки](src/System/MQ/Component/Extras/Error.hs)
  * [Вызов "удалённого" компонента](src/System/MQ/Component/Extras/Foreign.hs)
  * [Набор шаблонов для поведения](src/System/MQ/Component/Extras/Template)

